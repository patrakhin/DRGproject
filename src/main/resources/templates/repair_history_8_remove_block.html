<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Демонтаж Блоков</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script>
    function removeBlockAndThenDelete() {
      var blockName = $('#nameBlock').val();
      var blockNumber = $('#blockNumber').val();
      var positionRepair = $('#positionRepair').val();
      var csrfToken = $('input[name="_csrf"]').val();

      $.ajax({
        type: 'POST',
        url: '/repair_history/remove_block',
        data: {
          nameBlock: blockName,
          blockNumber: blockNumber,
          positionRepair: positionRepair,
          _csrf: csrfToken
        },
        success: function() {
          // После успешного выполнения AJAX-запроса отправляем скрытую форму для удаления блока
          $('#deleteBlockForm input[name="blockName"]').val(blockName);
          $('#deleteBlockForm input[name="blockNumber"]').val(blockNumber);
          $('#deleteBlockForm').submit();
        },
        error: function() {
          alert('Ошибка при удалении блока. Пожалуйста, попробуйте снова.');
        }
      });
    }
  </script>
</head>
<body>
<div class="container">
  <div class="row justify-content-center">
    <div class="col-12 text-center mb-3">
      <h1>Демонтаж Блоков</h1>
    </div>
    <div class="col-12">
      <table id="installedBlocksTable" class="table table-bordered">
        <thead>
        <tr>
          <th>Имя блока</th>
          <th>Номер блока</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="blockOnLocoDTO : ${blockOnLocoDTOS}" data-name-block="${blockOnLocoDTO.blockName}" data-block-number="${blockOnLocoDTO.blockNumber}">
          <td th:text="${blockOnLocoDTO.blockName}"></td>
          <td th:text="${blockOnLocoDTO.blockNumber}"></td>
        </tr>
        </tbody>
      </table>
    </div>
    <div class="col-12 text-center mb-3">
      <h3>Выберите блок для демонтажа</h3>
    </div>
    <form id="mainForm">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
      <div class="mb-3">
        <label for="nameBlock" class="form-label">Имя блока</label>
        <select id="nameBlock" name="nameBlock" class="form-control">
          <option th:each="blockOnLocoDTO : ${blockOnLocoDTOS}" th:value="${blockOnLocoDTO.blockName}" th:text="${blockOnLocoDTO.blockName}"></option>
        </select>
      </div>
      <div class="mb-3">
        <label for="blockNumber" class="form-label">Номер блока</label>
        <select id="blockNumber" name="blockNumber" class="form-control">
          <option th:each="blockOnLocoDTO : ${blockOnLocoDTOS}" th:value="${blockOnLocoDTO.blockNumber}" th:text="${blockOnLocoDTO.blockNumber}"></option>
        </select>
      </div>
      <div class="mb-3">
        <label for="positionRepair" class="form-label">Позиция ремонта</label>
        <select id="positionRepair" name="positionRepair" class="form-control">
          <option th:each="positionRepairDTO : ${positionRepairDTOS}" th:value="${positionRepairDTO.id}" th:text="${positionRepairDTO.posRepair}"></option>
        </select>
      </div>
      <button type="button" class="btn btn-danger" onclick="removeBlockAndThenDelete()">Демонтировать блок</button>
    </form>

    <!-- Скрытая форма для удаления блока -->
    <form id="deleteBlockForm" th:action="@{/block-on-locos/delete/repair}" method="post" style="display: none;">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
      <input type="hidden" name="blockName" value=""/>
      <input type="hidden" name="blockNumber" value=""/>
    </form>
  </div>
  <div class="col-12 text-center mt-3">
    <form th:action="@{/repair_history/search}" method="post">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
      <input type="hidden" name="typeLoco" th:value="${typeLoco}">
      <input type="hidden" name="numberLoco" th:value="${numberLoco}">
      <button type="submit" class="btn btn-primary">Перейти к панели работ</button>
    </form>
  </div>
</div>
</body>
</html>
