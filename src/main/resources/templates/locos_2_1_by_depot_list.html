<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="eng">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Список секций</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h1 class="text-center">Список секций</h1>

    <!-- Выпадающий список регионов -->
    <div class="mb-3">
        <label for="region" class="form-label">Выберите регион:</label>
        <select id="region" class="form-select">
            <option value="">Выберите регион</option>
            <option th:each="region : ${regions}" th:value="${region.name}" th:text="${region.name}"></option>
        </select>
    </div>

    <!-- Выпадающий список депо -->
    <div class="mb-3">
        <label for="homeDepot" class="form-label">Выберите депо:</label>
        <select id="homeDepot" class="form-select" disabled>
            <option value="">Сначала выберите регион</option>
        </select>
    </div>

    <!-- Выпадающий список типов локомотивов -->
    <div class="mb-3">
        <label for="typeLoco" class="form-label">Выберите тип локомотива:</label>
        <select id="typeLoco" class="form-select">
            <option value="">Выберите тип локомотива</option>
            <option th:each="typeLoco : ${types}" th:value="${typeLoco.locoType}" th:text="${typeLoco.locoType}"></option>
        </select>
    </div>

    <!-- Кнопка для выполнения поиска -->
    <button id="findSections" class="btn btn-primary" disabled>Найти</button>

    <!-- Таблица для отображения секций -->
    <table class="table mt-3" id="sectionsTable">
        <thead>
        <tr>
            <th scope="col">ID</th>
            <th scope="col">Серия локомотива</th>
            <th scope="col">Номер секции</th>
            <th scope="col">Депо приписки</th>
            <th scope="col">Регион</th>
            <th scope="col">Номер договора</th>
            <th scope="col">Действия</th>
        </tr>
        </thead>
        <tbody id="sectionsTableBody">
        <!-- Секции будут добавляться здесь через JavaScript -->
        </tbody>
    </table>

    <!-- Пагинация -->
    <div id="pagination" class="d-flex justify-content-center mt-3">
        <button id="firstPage" class="btn btn-secondary" disabled>Первая</button>
        <button id="prevPage" class="btn btn-secondary" disabled>Предыдущая</button>
        <span id="currentPageInfo" class="align-self-center mx-3"></span>
        <button id="nextPage" class="btn btn-secondary" disabled>Следующая</button>
        <button id="lastPage" class="btn btn-secondary" disabled>Последняя</button>
    </div>

    <div class="row mt-3">
        <div class="col-12 text-end">
            <a href="/locos" class="btn btn-link">Главная страница секций</a>
        </div>
    </div>
</div>

<!-- AJAX запросы для динамического взаимодействия -->
<script>
    let currentPage = 0;  // Текущая страница
    let totalPages = 0;    // Общее количество страниц

    // Обработчик выбора региона
    $('#region').change(function () {
        let regionName = $(this).val();
        $('#homeDepot').empty().append('<option value="">Загрузка депо...</option>').prop('disabled', true);
        $('#findSections').prop('disabled', true);
        $('#sectionsTableBody').empty();

        if (regionName) {
            // AJAX-запрос для получения депо по региону
            $.ajax({
                url: '/locos/depots',
                method: 'GET',
                data: { regionName: regionName },
                success: function (depots) {
                    $('#homeDepot').empty().append('<option value="">Выберите депо</option>');
                    $.each(depots, function (index, depot) {
                        $('#homeDepot').append('<option value="' + depot.depot + '">' + depot.depot + '</option>');
                    });
                    $('#homeDepot').prop('disabled', false);
                },
                error: function (error) {
                    console.error('Ошибка при получении депо:', error);
                    alert('Не удалось загрузить депо');
                }
            });
        }
    });

    // Обработчик изменения депо
    $('#homeDepot').change(function () {
        let homeDepot = $(this).val();
        let typeLoco = $('#typeLoco').val();

        $('#findSections').prop('disabled', !homeDepot || !typeLoco);  // Активируем кнопку "Найти", если все поля заполнены
    });

    // Обработчик выбора типа локомотива
    $('#typeLoco').change(function () {
        let homeDepot = $('#homeDepot').val();
        let typeLoco = $(this).val();

        $('#findSections').prop('disabled', !homeDepot || !typeLoco);  // Активируем кнопку "Найти", если все поля заполнены
    });

    // Функция для загрузки секций с учетом пагинации
    function loadSections() {
        let regionName = $('#region').val();
        let homeDepot = $('#homeDepot').val();
        let typeLoco = $('#typeLoco').val();

        $('#sectionsTableBody').empty();  // Очищаем таблицу

        if (regionName && homeDepot && typeLoco) {
            // AJAX-запрос для получения списка секций с их данными
            $.ajax({
                url: '/locos/section_type',
                method: 'GET',
                data: {
                    region: regionName,
                    homeDepot: homeDepot,
                    typeLoco: typeLoco,
                    page: currentPage,
                    size: 10  // Количество элементов на странице
                },
                success: function (response) {
                    totalPages = response.totalPages;  // Обновляем общее количество страниц
                    $('#currentPageInfo').text(`Страница ${currentPage + 1} из ${totalPages}`);
                    $.each(response.content, function (index, locoList) {
                        $('#sectionsTableBody').append(
                            '<tr>' +
                            '<td>' + locoList.id + '</td>' +
                            '<td>' + locoList.typeLoco + '</td>' +
                            '<td>' + locoList.locoNumber + '</td>' +
                            '<td>' + locoList.homeDepot + '</td>' +
                            '<td>' + locoList.homeRegion + '</td>' +
                            '<td>' + locoList.contractNumber + '</td>' +
                            '<td>' +
                            '<a href="/locos/detail/' + locoList.id + '" class="btn btn-primary btn-sm">Детали</a> ' +
                            '<a href="/locos/edit/' + locoList.id + '" class="btn btn-warning btn-sm">Редактировать</a> ' +
                            '<a href="/locos/delete/' + locoList.id + '" class="btn btn-danger btn-sm">Удалить</a>' +
                            '</td>' +
                            '</tr>'
                        );
                    });

                    // Обновление состояния кнопок пагинации
                    updatePaginationButtons();
                },
                error: function (error) {
                    console.error('Ошибка при получении данных:', error);
                    alert('Не удалось загрузить данные о локомотивах');
                }
            });
        }
    }

    // Обработчик кнопки "Найти"
    $('#findSections').click(function () {
        currentPage = 0;  // Сброс страницы при новом поиске
        loadSections();
    });

    // Обновление состояния кнопок пагинации
    function updatePaginationButtons() {
        $('#firstPage').prop('disabled', currentPage === 0);
        $('#prevPage').prop('disabled', currentPage === 0);
        $('#nextPage').prop('disabled', currentPage >= totalPages - 1);
        $('#lastPage').prop('disabled', currentPage >= totalPages - 1);
    }

    // Обработчики кнопок пагинации
    $('#firstPage').click(function () {
        currentPage = 0;
        loadSections();
    });

    $('#prevPage').click(function () {
        if (currentPage > 0) {
            currentPage--;
            loadSections();
        }
    });

    $('#nextPage').click(function () {
        if (currentPage < totalPages - 1) {
            currentPage++;
            loadSections();
        }
    });

    $('#lastPage').click(function () {
        currentPage = totalPages - 1;
        loadSections();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
