<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Формирование ТПС</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-label {
            transition: color 0.3s ease;
        }
        .status-equipped {
            color: green;
        }
        .status-not-equipped {
            color: red;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row justify-content-center mt-4">
        <div class="col-12 text-center mb-4">
            <h1>Формирование ТПС</h1>
        </div>
        <div class="col-12">
            <form action="/loco_info/create/tps" method="post">
                <!-- CSRF токен -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <!-- Скрытые поля для сохранения выбранного региона и депо -->
                <input type="hidden" id="selectedRegion" name="selectedRegion" th:value="${locoInfo.region}">
                <input type="hidden" id="selectedDepot" name="selectedDepot" th:value="${locoInfo.homeDepot}">

                <!-- Секция выбора региона, депо и серии локомотива -->
                <div class="mb-3 row">
                    <label for="region" class="col-sm-2 col-form-label">Регион:</label>
                    <div class="col-sm-3">
                        <select id="region" name="region" class="form-select" required>
                            <option value="">Выберите регион</option>
                            <option th:each="region : ${regions}" th:value="${region.name}" th:text="${region.name}"></option>
                        </select>
                    </div>
                    <label for="homeDepot" class="col-sm-2 col-form-label">Депо приписки:</label>
                    <div class="col-sm-3">
                        <select id="homeDepot" name="homeDepot" class="form-select" required>
                            <option value="">Выберите депо</option>
                        </select>
                    </div>
                </div>

                <!-- Секция выбора серии локомотива -->
                <div class="mb-3 row">
                    <label for="typeLoco" class="col-sm-3 col-form-label">Серия локомотива:</label>
                    <div class="col-sm-9">
                        <select id="typeLoco" name="typeLoco" class="form-select" required>
                            <option value="">Выберите серию локомотива</option>
                            <option th:each="typeLoco : ${typeLocos}" th:value="${typeLoco.locoType}" th:text="${typeLoco.locoType}"></option>
                        </select>
                    </div>
                </div>

                <!-- Секция 1 -->
                <div class="mb-3 row">
                    <label for="section1" class="col-sm-3 col-form-label">Секция 1:</label>
                    <div class="col-sm-6">
                        <select id="section1" name="section1" class="form-select">
                            <option value="">Выберите секцию</option>
                        </select>
                    </div>
                    <div class="col-sm-3 d-flex align-items-center">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="section1Status" name="section1Status" onchange="updateStatusLabel(this, 'section1StatusLabel')">
                            <label class="form-check-label status-label" id="section1StatusLabel">Не оборудован</label>
                        </div>
                    </div>
                </div>

                <!-- Секция 2 -->
                <div class="mb-3 row">
                    <label for="section2" class="col-sm-3 col-form-label">Секция 2:</label>
                    <div class="col-sm-6">
                        <select id="section2" name="section2" class="form-select">
                            <option value="">Выберите секцию</option>
                        </select>
                    </div>
                    <div class="col-sm-3 d-flex align-items-center">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="section2Status" name="section2Status" onchange="updateStatusLabel(this, 'section2StatusLabel')">
                            <label class="form-check-label status-label" id="section2StatusLabel">Не оборудован</label>
                        </div>
                    </div>
                </div>

                <!-- Секция 3 -->
                <div class="mb-3 row">
                    <label for="section3" class="col-sm-3 col-form-label">Секция 3:</label>
                    <div class="col-sm-6">
                        <select id="section3" name="section3" class="form-select">
                            <option value="">Выберите секцию</option>
                        </select>
                    </div>
                    <div class="col-sm-3 d-flex align-items-center">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="section3Status" name="section3Status" onchange="updateStatusLabel(this, 'section3StatusLabel')">
                            <label class="form-check-label status-label" id="section3StatusLabel">Не оборудован</label>
                        </div>
                    </div>
                </div>

                <!-- Секция 4 -->
                <div class="mb-3 row">
                    <label for="section4" class="col-sm-3 col-form-label">Секция 4:</label>
                    <div class="col-sm-6">
                        <select id="section4" name="section4" class="form-select">
                            <option value="">Выберите секцию</option>
                        </select>
                    </div>
                    <div class="col-sm-3 d-flex align-items-center">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="section4Status" name="section4Status" onchange="updateStatusLabel(this, 'section4StatusLabel')">
                            <label class="form-check-label status-label" id="section4StatusLabel">Не оборудован</label>
                        </div>
                    </div>
                </div>

                <!-- Кнопка создания и ссылка на управление -->
                <div class="text-center mb-3">
                    <button type="submit" class="btn btn-primary">Сформировать ТПС</button>
                </div>
                <div class="text-end">
                    <a href="/loco_info/manage" class="btn btn-secondary">Управление ТПС</a>
                </div>

                <!-- Сообщения об ошибке и успешном создании -->
                <div th:if="${errorMessage}" class="alert alert-danger mt-3" role="alert">
                    <p th:text="${errorMessage}"></p>
                </div>
                <div id="successMessage" th:if="${successMessage}" class="alert alert-success mt-3" role="alert">
                    <p th:text="${successMessage}"></p>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {
        const selectedRegion = $('#selectedRegion').val();
        const selectedDepot = $('#selectedDepot').val();

        if (selectedRegion) {
            loadDepots(selectedRegion, selectedDepot);
        }

        $('#region').change(function() {
            const selectedRegion = $(this).val();
            $('#selectedRegion').val(selectedRegion);
            $('#selectedDepot').val('');
            $('#typeLoco').val('');
            $('#section1, #section2, #section3, #section4').empty().append('<option value="">Выберите секцию</option>');
            loadDepots(selectedRegion);
        });

        $('#homeDepot').change(function() {
            loadFreeSections();
        });

        $('#typeLoco').change(function() {
            loadFreeSections();
        });

        // Проверка наличия успешного сообщения и задержка
        const successMessageDiv = $('#successMessage');
        if (successMessageDiv.length) {
            setTimeout(function() {
                window.location.href = '/loco_info/create'; // Перенаправление через 2 секунды
            }, 2000); // Задержка 2 секунды
        }
    });

    function loadDepots(regionName, selectedDepot) {
        const $homeDepotSelect = $('#homeDepot');

        // Очистка текущих опций депо
        $homeDepotSelect.empty();
        $homeDepotSelect.append($('<option></option>').text('Выберите депо'));

        if (regionName) {
            $.ajax({
                url: '/locos/depots',  // Путь для получения депо
                type: 'GET',
                data: {
                    regionName: regionName
                },
                success: function(data) {
                    if (data.length === 0) {
                        $homeDepotSelect.append($('<option></option>').text('Нет депо для выбранного региона'));
                    } else {
                        $.each(data, function(index, depot) {
                            const option = $('<option></option>')
                                .attr('value', depot.depot)
                                .text(depot.depot);

                            if (depot.depot === selectedDepot) {
                                option.attr('selected', 'selected');
                            }

                            $homeDepotSelect.append(option);
                        });
                    }
                },
                error: function() {
                    alert('Ошибка при загрузке депо');
                }
            });
        }
    }

    function loadFreeSections() {
        const region = $('#region').val();
        const depot = $('#homeDepot').val();
        const typeLoco = $('#typeLoco').val();

        if (region && depot && typeLoco) {
            $.ajax({
                url: '/loco_info/sections',  // Путь для получения свободных секций
                type: 'GET',
                data: {
                    homeRegion: region,
                    homeDepot: depot,
                    typeLoco: typeLoco
                },
                success: function(data) {
                    const $sectionSelects = $('#section1, #section2, #section3, #section4');

                    // Очистка текущих опций секций
                    $sectionSelects.each(function() {
                        $(this).empty();
                        $(this).append($('<option></option>').text('Выберите секцию'));
                    });

                    if (data.length === 0) {
                        alert('Нет свободных секций для выбранного типа ТПС');
                    } else {
                        $.each(data, function(index, section) {
                            const option = $('<option></option>')
                                .attr('value', section)
                                .text(section);

                            $sectionSelects.append(option);
                        });
                    }
                },
                error: function() {
                    alert('Ошибка при загрузке свободных секций');
                }
            });
        }
    }

    function updateStatusLabel(checkbox, labelId) {
        const label = document.getElementById(labelId);
        if (checkbox.checked) {
            label.textContent = 'Оборудован';
            label.classList.remove('status-not-equipped');
            label.classList.add('status-equipped');
        } else {
            label.textContent = 'Не оборудован';
            label.classList.remove('status-equipped');
            label.classList.add('status-not-equipped');
        }
    }
</script>
</body>
</html>
